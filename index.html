<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Onde Comprar | Chumbada Oficial</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <style>
    :root {
      --primary: #006FB9;
      --accent: #F97316;
      --bg: #F8FAFC;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: #0F172A; }
    h1 { font-family: 'Bebas Neue', sans-serif; text-transform: uppercase; letter-spacing: 1px; color: var(--primary); font-size: 3.5rem; text-align: center; margin: 40px 0 10px; }
    p.subtitle { text-align: center; color: #64748B; margin-bottom: 30px; }

    header { background: white; padding: 15px 0; border-bottom: 1px solid #e2e8f0; text-align: center; position: sticky; top: 0; z-index: 1000; }
    header img { height: 40px; }

    .search-container { max-width: 900px; margin: 0 auto 30px; padding: 0 20px; }
    .search-box { background: white; padding: 10px; border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); display: flex; gap: 10px; border: 1px solid #e2e8f0; }
    .search-box input { flex: 1; border: none; padding: 10px 20px; font-size: 1rem; outline: none; border-radius: 30px; }
    
    .btn { border: none; padding: 12px 25px; border-radius: 30px; font-weight: 700; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
    .btn-search { background: var(--primary); color: white; }
    .btn-gps { background: #f1f5f9; color: var(--primary); }
    .btn:hover { transform: scale(1.02); opacity: 0.9; }

    .main-layout { max-width: 1240px; margin: 0 auto; padding: 0 20px 50px; display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
    #map { height: 550px; border-radius: 20px; border: 1px solid #e2e8f0; z-index: 1; }
    .side-list { background: white; border-radius: 20px; height: 550px; overflow-y: auto; padding: 20px; border: 1px solid #e2e8f0; }

    .store-card { padding: 15px; border-radius: 12px; border: 1px solid #f1f5f9; margin-bottom: 15px; cursor: pointer; transition: 0.2s; border-left: 5px solid var(--primary); }
    .store-card:hover { background: #f0f9ff; border-color: var(--primary); }
    .dist-tag { background: var(--accent); color: white; padding: 2px 8px; border-radius: 5px; font-size: 0.7rem; font-weight: 900; margin-bottom: 5px; display: inline-block; }

    @media (max-width: 900px) {
      .main-layout { grid-template-columns: 1fr; }
      .search-box { flex-direction: column; border-radius: 20px; }
      .btn { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>

<header><img src="https://cdn.shopify.com/s/files/1/0454/5845/6736/files/Logo-chumbada-OFICIAL-horizonatal-2_f758e5db-514c-4559-8549-94cd56f40ef7.png?v=1756759937"></header>

<h1>Onde Comprar</h1>
<p class="subtitle">Encontre a revenda Chumbada Oficial mais próxima de você.</p>

<div class="search-container">
    <div class="search-box">
        <input type="text" id="addressInput" placeholder="Cidade, CEP ou Bairro...">
        <button class="btn btn-gps" onclick="useGPS()"><i class="ph ph-map-pin"></i> GPS</button>
        <button class="btn btn-search" onclick="doSearch()"><i class="ph ph-magnifying-glass"></i> BUSCAR</button>
    </div>
</div>

<div class="main-layout">
    <div id="map"></div>
    <div class="side-list" id="storeList">
        <p style="text-align: center; color: #94a3b8; margin-top: 50px;">Carregando lojas...</p>
    </div>
</div>

<script>
    var map = L.map('map').setView([-14.235, -51.925], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var markers = L.layerGroup().addTo(map);
    var stores = [];

    // Carregar CSV
    Papa.parse("lojas.csv", {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            stores = results.data;
            console.log("Lojas carregadas:", stores.length);
            
            stores.forEach(s => {
                let lat = parseFloat(String(s.latitude).replace(',', '.'));
                let lon = parseFloat(String(s.longitude).replace(',', '.'));
                if(!isNaN(lat) && !isNaN(lon)) {
                    L.marker([lat, lon]).addTo(markers).bindPopup(`<b>${s.nome}</b><br>${s.descricao || ''}`);
                }
            });
            document.getElementById('storeList').innerHTML = '<p style="text-align:center; color:#64748B;">Use a busca acima para listar lojas por proximidade.</p>';
        },
        error: function() {
            document.getElementById('storeList').innerHTML = '<p style="color:red; text-align:center;"><b>Erro:</b> O arquivo "lojas.csv" não foi encontrado. Verifique se ele está na mesma pasta e com nome minúsculo.</p>';
        }
    });

    function doSearch() {
        let q = document.getElementById('addressInput').value;
        if(!q) return;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&countrycodes=br&limit=1`)
            .then(r => r.json())
            .then(data => {
                if(data.length > 0) processResult(parseFloat(data[0].lat), parseFloat(data[0].lon));
                else alert("Local não encontrado.");
            });
    }

    function useGPS() {
        if (!navigator.geolocation) return alert("GPS não suportado.");
        navigator.geolocation.getCurrentPosition(p => processResult(p.coords.latitude, p.coords.longitude));
    }

    function processResult(lat, lon) {
        map.setView([lat, lon], 12);
        let sorted = stores.map(s => {
            let sLat = parseFloat(String(s.latitude).replace(',', '.'));
            let sLon = parseFloat(String(s.longitude).replace(',', '.'));
            let d = Math.sqrt(Math.pow(sLat - lat, 2) + Math.pow(sLon - lon, 2)) * 111;
            return {...s, d, sLat, sLon};
        }).filter(s => !isNaN(s.d)).sort((a,b) => a.d - b.d).slice(0, 15);

        let html = '<h3>Lojas mais próximas:</h3>';
        sorted.forEach(s => {
            html += `
                <div class="store-card" onclick="map.setView([${s.sLat}, ${s.sLon}], 15)">
                    <span class="dist-tag">${s.d.toFixed(1)} KM</span>
                    <h4>${s.nome}</h4>
                    <p>${s.descricao || ''}</p>
                    <p style="color:var(--primary); font-weight:700; margin-top:5px;">${s.telefone || ''}</p>
                </div>`;
        });
        document.getElementById('storeList').innerHTML = html;
    }
</script>

</body>
</html>
