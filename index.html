<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Onde Comprar | Chumbada Oficial</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <style>
    :root {
      --primary: #006FB9;
      --accent: #F97316;
      --bg: #F8FAFC;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: #0F172A; -webkit-tap-highlight-color: transparent; }
    
    header { background: white; padding: 12px 0; border-bottom: 1px solid #e2e8f0; text-align: center; position: sticky; top: 0; z-index: 1000; }
    header img { height: 35px; }

    h1 { font-family: 'Bebas Neue', sans-serif; text-transform: uppercase; color: var(--primary); font-size: 2.5rem; text-align: center; margin: 25px 0 5px; }
    .subtitle { text-align: center; color: #64748B; font-size: 0.9rem; margin-bottom: 20px; padding: 0 20px; }

    .search-container { max-width: 900px; margin: 0 auto 20px; padding: 0 15px; }
    .search-box { background: white; padding: 8px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; gap: 8px; border: 1px solid #e2e8f0; }
    .search-box input { flex: 1; border: none; padding: 12px 15px; font-size: 1rem; outline: none; border-radius: 10px; width: 100%; }
    
    .btn-group { display: flex; gap: 8px; }
    .btn { border: none; padding: 12px 20px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .btn-search { background: var(--primary); color: white; flex: 2; }
    .btn-gps { background: #f1f5f9; color: var(--primary); flex: 1; }

    .main-layout { max-width: 1240px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; padding: 0 15px 40px; }
    
    /* MAPA: Altura fixa menor no mobile */
    #map { height: 350px; width: 100%; border-radius: 15px; border: 1px solid #e2e8f0; z-index: 1; }
    
    .side-list { background: white; border-radius: 15px; padding: 20px; border: 1px solid #e2e8f0; }
    .side-list h3 { font-family: 'Bebas Neue', sans-serif; color: var(--primary); margin-bottom: 15px; font-size: 1.5rem; }

    .store-card { padding: 15px; border-radius: 12px; border: 1px solid #f1f5f9; margin-bottom: 12px; cursor: pointer; border-left: 5px solid var(--primary); background: #fff; }
    .store-card:active { background: #f0f9ff; }
    .dist-tag { background: var(--accent); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 900; margin-bottom: 5px; display: inline-block; }

    /* Ajustes para Desktop */
    @media (min-width: 900px) {
      .main-layout { flex-direction: row; align-items: flex-start; }
      #map { height: 600px; flex: 1; position: sticky; top: 80px; }
      .side-list { width: 380px; height: 600px; overflow-y: auto; }
      h1 { font-size: 4rem; }
      .search-box { border-radius: 50px; padding: 10px; }
    }

    /* Mobile: Botões em linha */
    @media (max-width: 600px) {
      .search-box { flex-direction: column; border-radius: 20px; }
      .btn-group { width: 100%; }
      #map { height: 300px; } /* Menor ainda no celular para sobrar tela */
    }
  </style>
</head>
<body>

<header><img src="https://cdn.shopify.com/s/files/1/0454/5845/6736/files/Logo-chumbada-OFICIAL-horizonatal-2_f758e5db-514c-4559-8549-94cd56f40ef7.png?v=1756759937"></header>

<div class="container">
    <h1>Onde Comprar</h1>
    <p class="subtitle">Encontre a revenda Chumbada Oficial mais próxima de você.</p>

    <div class="search-container">
        <div class="search-box">
            <input type="text" id="addressInput" placeholder="Cidade ou CEP...">
            <div class="btn-group">
                <button class="btn btn-gps" onclick="useGPS()"><i class="ph ph-map-pin"></i> GPS</button>
                <button class="btn btn-search" onclick="doSearch()"><i class="ph ph-magnifying-glass"></i> BUSCAR</button>
            </div>
        </div>
    </div>

    <div class="main-layout">
        <div id="map"></div>
        <div class="side-list" id="storeList">
            <h3>Lojas</h3>
            <p id="statusMsg" style="color: #94a3b8; font-size: 0.9rem;">Buscando lojas disponíveis...</p>
        </div>
    </div>
</div>

<script>
    // Inicializa o mapa com "tap" desativado para ajudar na rolagem mobile
    var map = L.map('map', {
        tap: false, 
        dragging: !L.Browser.mobile, // Desativa arraste com 1 dedo no mobile por padrão
        scrollWheelZoom: false // Evita zoom acidental ao rolar a página
    }).setView([-14.235, -51.925], 4);

    // Se for mobile, avisa que precisa de 2 dedos ou habilita scroll da página por cima do mapa
    if (L.Browser.mobile) {
        map.dragging.disable();
        map.once('focus', function() { map.dragging.enable(); });
    }

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var markers = L.layerGroup().addTo(map);
    var stores = [];

    // Carregar CSV
    Papa.parse("lojas.csv", {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            stores = results.data;
            stores.forEach(s => {
                let lat = parseFloat(String(s.latitude).replace(',', '.'));
                let lon = parseFloat(String(s.longitude).replace(',', '.'));
                if(!isNaN(lat) && !isNaN(lon)) {
                    L.marker([lat, lon]).addTo(markers).bindPopup(`<b>${s.nome}</b><br>${s.descricao || ''}`);
                }
            });
            document.getElementById('statusMsg').innerText = 'Use a busca para listar por proximidade.';
        },
        error: function() {
            document.getElementById('statusMsg').innerHTML = '<span style="color:red">Erro ao carregar lojas.csv</span>';
        }
    });

    function doSearch() {
        let q = document.getElementById('addressInput').value;
        if(!q) return;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&countrycodes=br&limit=1`)
            .then(r => r.json())
            .then(data => {
                if(data.length > 0) processResult(parseFloat(data[0].lat), parseFloat(data[0].lon));
                else alert("Local não encontrado.");
            });
    }

    function useGPS() {
        if (!navigator.geolocation) return alert("GPS não suportado.");
        navigator.geolocation.getCurrentPosition(p => processResult(p.coords.latitude, p.coords.longitude));
    }

    function processResult(lat, lon) {
        map.setView([lat, lon], 12);
        let sorted = stores.map(s => {
            let sLat = parseFloat(String(s.latitude).replace(',', '.'));
            let sLon = parseFloat(String(s.longitude).replace(',', '.'));
            let d = Math.sqrt(Math.pow(sLat - lat, 2) + Math.pow(sLon - lon, 2)) * 111;
            return {...s, d, sLat, sLon};
        }).filter(s => !isNaN(s.d)).sort((a,b) => a.dist - b.dist).slice(0, 15);

        let html = '<h3>Lojas mais próximas:</h3>';
        sorted.forEach(s => {
            html += `
                <div class="store-card" onclick="map.setView([${s.sLat}, ${s.sLon}], 15); window.scrollTo({top: 0, behavior: 'smooth'});">
                    <span class="dist-tag">${s.d.toFixed(1)} KM</span>
                    <h4>${s.nome}</h4>
                    <p>${s.descricao || ''}</p>
                    <p style="color:var(--primary); font-weight:700; margin-top:5px;">${s.telefone || ''}</p>
                </div>`;
        });
        document.getElementById('storeList').innerHTML = html;
        
        // No mobile, rola automaticamente para a lista após a busca
        if(window.innerWidth < 900) {
            document.getElementById('storeList').scrollIntoView({ behavior: 'smooth' });
        }
    }
</script>

</body>
</html>
